
## Simple mitigation script for CVE-2022-30190 based on the guidance below.
## https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/

## Script Functionality
## Export the key (in case we need to undo these changes) to c:\backup and delete the key 'HKEY_CLASSES_ROOT\ms-msdt'
## Please note that this script will not remove any files from the regpath location by itself, it must be checked and reviewed manually, unless you wish to alter this script.

## Usage
## Script may be loaded via InTune for MDM. 
## Execute the script from an elevated PowerShell window locally.

## Legal
## Sentrium will not be held liable should any damage be caused by the use of this script.


# Change the location of the backup folder here if needed
$backup = 'C:\backup'
# Change the filepath of the registry key here if needed
$regfile = 'C:\backup\msdt.reg'

# try/catch
try{
    # Check if the $backup location already exists
    if (Test-Path -Path $backup){
        "Path exists, checking for file"
        # Check if the $regfile file exists
        if (Test-Path -Path $regfile -PathType Leaf){
            "File already exists, please check if the registry key has been removed previously, if not then delete the file stored in $regfile and run script again"
            exit
        }
        else{
            # Export the reg key for backup (as per guidance)
            "Exporting reg key"
            reg export HKEY_CLASSES_ROOT\ms-msdt c:\backup\msdt.reg
        }
    }
    else{
        # Create the directory as created above
        "Creating dir"
        New-Item -Path $backup -ItemType directory
        "Saving reg key as backup"
        reg export HKEY_CLASSES_ROOT\ms-msdt $regfile
    }
}
catch{
    Write-Host "An error occurred:"
    Write-Host $_
}

# Once the backup has been taken, delete the target regsitry key (as per guidance)
try {
    "Deleting reg key"
    reg delete HKEY_CLASSES_ROOT\ms-msdt /f
    "Key successfully deleted. Workaround successfully applied!"
}
catch{
    Write-Host "An error occurred:"
    Write-Host $_
}